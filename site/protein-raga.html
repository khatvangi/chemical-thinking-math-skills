<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protein-Raga Studio | Scientific Sonification</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 2rem;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slide-in-from-top-2 { from { transform: translateY(-8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-in { animation: fade-in 0.3s ease-out, slide-in-from-top-2 0.3s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // Lucide icon components
    const Icon = ({ name, className }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          lucide.createIcons({ icons: { [name]: lucide.icons[name] }, nameAttr: 'data-lucide' });
          const svg = document.createElement('div');
          svg.innerHTML = `<svg data-lucide="${name}"></svg>`;
          ref.current.appendChild(svg.firstChild);
          lucide.createIcons({ attrs: { class: className || 'w-4 h-4' } });
        }
      }, [name]);
      return <span ref={ref} className={`inline-flex items-center justify-center ${className || ''}`}></span>;
    };

    // Simple SVG icons inline
    const Play = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="6 3 20 12 6 21 6 3"></polygon>
      </svg>
    );
    const Pause = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="14" y="4" width="4" height="16" rx="1"></rect>
        <rect x="6" y="4" width="4" height="16" rx="1"></rect>
      </svg>
    );
    const RefreshCw = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
        <path d="M21 3v5h-5"></path>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
        <path d="M8 16H3v5"></path>
      </svg>
    );
    const Search = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.3-4.3"></path>
      </svg>
    );
    const FlaskConical = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"></path>
        <path d="M8.5 2h7"></path>
        <path d="M7 16h10"></path>
      </svg>
    );
    const Info = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v-4"></path>
        <path d="M12 8h.01"></path>
      </svg>
    );
    const X = ({ className }) => (
      <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M18 6 6 18"></path>
        <path d="m6 6 12 12"></path>
      </svg>
    );

    /*
     * PROTEIN-RAGA v7: SCIENTIFIC VALIDATION STUDIO
     * New Feature: "Science Behind" Logic Panel
     * Explains Mass-Pitch relation, Raga-Chemistry mapping, and That definitions.
     */

    // DATA POOLS
    const SCIENTIFIC_POOL = {
      kinases: [
        { id: 'P42336', name: 'PI3K CA (Alpha)', desc: 'Kinase / Cancer Driver' },
        { id: 'P42338', name: 'PI3K CB (Beta)', desc: 'Kinase / Signaling' },
        { id: 'P28482', name: 'MAPK1 (ERK2)', desc: 'Kinase / Cell Growth' },
        { id: 'P00533', name: 'EGFR', desc: 'Receptor Tyrosine Kinase' },
      ],
      gpcrs: [
        { id: 'P14416', name: 'Dopamine D2', desc: 'GPCR / Neurotransmitter' },
        { id: 'P08100', name: 'Rhodopsin', desc: 'GPCR / Vision' },
        { id: 'P29274', name: 'Adenosine A2A', desc: 'GPCR / Caffeine Target' },
        { id: 'P35348', name: 'Alpha-1A Adrenergic', desc: 'GPCR / Heart Rate' },
      ],
    };

    const INITIAL_SEQ_A = "MVLSPADKTNVKAAWGKVGAHAGEYGAEALERMFLSFPTTKTYFPHFDLSHGSAQVKGHGKKVADALTNAVAHVDDMPNALSALSDLHAHKLRVDPVNFKLLSHCLLVTLAAHLPAEFTPAVHASLDKFLASVSTVLTSKYR";
    const INITIAL_SEQ_B = "MVHLTPEEKSAVTALWGKVNVDEVGGEALGRLLVVYPWTQRFFESFGDLSTPDAVMGNPKVKAHGKKVLGAFSDGLAHLDNLKGTFATLSELHCDKLHVDPENFRLLGNVLVCVLAHHFGKEFTPPVQAAYQKVVAGVANALAHKYH";

    // MUSICAL-CHEMICAL ENGINE
    const BASE_FREQ = 138.59; // C#3

    const SHRUTIS = {
      'S': 1/1, 'r1': 256/243, 'R2': 9/8, 'g1': 32/27, 'G2': 81/64,
      'M1': 4/3, 'm1': 45/32, 'P': 3/2, 'd1': 128/81, 'D2': 27/16, 'N1': 15/8
    };

    const AMINO_DATA = {
      // KANTHYA (Hydrophobic) - Grounded
      'A': { mw: 89,  class: 'Hydro', varga: 'Kanthya' },
      'V': { mw: 117, class: 'Hydro', varga: 'Kanthya' },
      'L': { mw: 131, class: 'Hydro', varga: 'Kanthya' },
      'I': { mw: 131, class: 'Hydro', varga: 'Kanthya' },
      'M': { mw: 149, class: 'Hydro', varga: 'Kanthya' },
      // TALAVYA (Polar) - Liquid
      'S': { mw: 105, class: 'Polar', varga: 'Talavya' },
      'T': { mw: 119, class: 'Polar', varga: 'Talavya' },
      'N': { mw: 132, class: 'Polar', varga: 'Talavya' },
      'Q': { mw: 146, class: 'Polar', varga: 'Talavya' },
      // MURDHANYA/DANTYA (Charged) - Energetic
      'K': { mw: 146, class: 'Pos',   varga: 'Murdhanya' },
      'R': { mw: 174, class: 'Pos',   varga: 'Murdhanya' },
      'D': { mw: 133, class: 'Neg',   varga: 'Dantya' },
      'E': { mw: 147, class: 'Neg',   varga: 'Dantya' },
      // OSTHYA (Aromatic) - Resonant
      'F': { mw: 165, class: 'Arom',  varga: 'Osthya' },
      'Y': { mw: 181, class: 'Arom',  varga: 'Osthya' },
      'W': { mw: 204, class: 'Arom',  varga: 'Osthya' },
      // ANTAHSTHA (Special) - Flexible
      'G': { mw: 75,  class: 'Spec',  varga: 'Antahstha' },
      'P': { mw: 115, class: 'Spec',  varga: 'Antahstha' },
      'C': { mw: 121, class: 'Spec',  varga: 'Antahstha' },
    };

    const RAGAS = {
      bhairav: { name: 'Bhairav', desc: 'Hydrophobic/Grounded', svaras: ['S', 'r1', 'G2', 'M1', 'P', 'd1', 'N1'], color: '#8B4513', that: 'Bhairav' },
      marwa:   { name: 'Marwa',   desc: 'Charged/Reactive',     svaras: ['S', 'r1', 'G2', 'm1', 'D2', 'N1'],      color: '#DAA520', that: 'Marwa' },
      yaman:   { name: 'Yaman',   desc: 'Mixed/Fluid',          svaras: ['S', 'R2', 'G2', 'm1', 'P', 'D2', 'N1'], color: '#228B22', that: 'Kalyan' },
      darbari: { name: 'Darbari', desc: 'Aromatic/Heavy',       svaras: ['S', 'r1', 'g1', 'M1', 'P', 'd1', 'N1'], color: '#483D8B', that: 'Asavari' }
    };

    // LOGIC & AUDIO
    function determineRaga(seq) {
      if (!seq) return RAGAS.yaman;
      let hydro = 0, charge = 0, arom = 0, total = 0;
      const sample = seq.substring(0, 200);
      for (let char of sample) {
        const d = AMINO_DATA[char];
        if (d) {
          if (d.class === 'Hydro') hydro++;
          if (d.class === 'Pos' || d.class === 'Neg') charge++;
          if (d.class === 'Arom') arom++;
          total++;
        }
      }
      hydro /= total; charge /= total; arom /= total;

      if (arom > 0.10) return RAGAS.darbari;
      if (charge > 0.25) return RAGAS.marwa;
      if (hydro > 0.45) return RAGAS.bhairav;
      return RAGAS.yaman;
    }

    function calculateHomology(seqA, seqB) {
      let score = 0;
      let notes = [];
      const len = Math.min(100, Math.max(seqA.length, seqB.length));
      for(let i=0; i<len; i++) {
        const a = seqA[i];
        const b = seqB[i];
        if (!a || !b) { notes.push('gap'); continue; }
        if (a === b) { score += 1; notes.push('identity'); }
        else if (AMINO_DATA[a]?.varga === AMINO_DATA[b]?.varga) { score += 0.5; notes.push('consonance'); }
        else { score -= 0.25; notes.push('dissonance'); }
      }
      return { percent: Math.max(0, (score / len) * 100).toFixed(1), map: notes };
    }

    function getNote(char, raga) {
      const d = AMINO_DATA[char];
      if (!d) return null;
      const idx = char.charCodeAt(0) % raga.svaras.length;
      const svara = raga.svaras[idx];
      let oct = 0;
      if (d.mw < 100) oct = 1;
      if (d.mw > 160) oct = -1;
      return { freq: BASE_FREQ * SHRUTIS[svara] * Math.pow(2, oct), name: svara };
    }

    // MAIN COMPONENT
    function ProteinRagaStudio() {
      const [dataA, setDataA] = useState({ id: 'P01922', name: 'Hemoglobin A', seq: INITIAL_SEQ_A });
      const [dataB, setDataB] = useState({ id: 'P02751', name: 'Hemoglobin B', seq: INITIAL_SEQ_B });
      const [loading, setLoading] = useState(false);
      const [playing, setPlaying] = useState(false);
      const [currIdx, setCurrIdx] = useState(-1);
      const [searchId, setSearchId] = useState('');
      const [showScience, setShowScience] = useState(false);

      const ragaA = useMemo(() => determineRaga(dataA.seq), [dataA.seq]);
      const ragaB = useMemo(() => determineRaga(dataB.seq), [dataB.seq]);
      const homology = useMemo(() => calculateHomology(dataA.seq, dataB.seq), [dataA.seq, dataB.seq]);

      const audioCtx = useRef(null);

      const fetchProtein = async (id, target) => {
        setLoading(true);
        try {
          const response = await fetch(`https://rest.uniprot.org/uniprotkb/${id}.json`);
          if(!response.ok) throw new Error("Protein not found");
          const data = await response.json();
          const newData = {
            id: data.primaryAccession,
            name: data.uniProts ? data.uniProts[0].recommendedName.fullName.value : data.proteinDescription.recommendedName.fullName.value,
            seq: data.sequence.value
          };
          if (target === 'A') setDataA(newData);
          else setDataB(newData);
          setPlaying(false);
          setCurrIdx(-1);
        } catch (err) {
          alert(`Error fetching ${id}: ${err.message}`);
        }
        setLoading(false);
      };

      const loadRandom = (category, target) => {
        const list = SCIENTIFIC_POOL[category];
        const rand = list[Math.floor(Math.random() * list.length)];
        fetchProtein(rand.id, target);
      };

      const playComparison = () => {
        if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
        if (playing) { setPlaying(false); setCurrIdx(-1); return; }

        setPlaying(true);
        const ctx = audioCtx.current;
        let now = ctx.currentTime + 0.1;
        const len = Math.min(100, Math.max(dataA.seq.length, dataB.seq.length));

        for (let i = 0; i < len; i++) {
          const charA = dataA.seq[i];
          const charB = dataB.seq[i];

          if (charA) {
            const nA = getNote(charA, ragaA);
            if (nA) {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              const pan = ctx.createStereoPanner();
              osc.type = 'triangle'; osc.frequency.value = nA.freq; pan.pan.value = -0.5;
              gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
              osc.connect(pan); pan.connect(gain); gain.connect(ctx.destination);
              osc.start(now); osc.stop(now + 0.4);
            }
          }
          if (charB) {
            const nB = getNote(charB, ragaB);
            if (nB) {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              const pan = ctx.createStereoPanner();
              osc.type = 'sawtooth'; osc.frequency.value = nB.freq; pan.pan.value = 0.5;
              gain.gain.setValueAtTime(0.08, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
              osc.connect(pan); pan.connect(gain); gain.connect(ctx.destination);
              osc.start(now); osc.stop(now + 0.4);
            }
          }
          setTimeout(() => setCurrIdx(i), (now - ctx.currentTime) * 1000);
          now += 0.25;
        }
        setTimeout(() => { setPlaying(false); setCurrIdx(-1); }, (now - ctx.currentTime) * 1000);
      };

      return (
        <div className="w-full max-w-5xl mx-auto p-6 bg-slate-950 text-slate-100 rounded-xl font-sans shadow-2xl border border-slate-800">

          {/* Header */}
          <div className="flex justify-between items-end mb-6 pb-4 border-b border-slate-800">
            <div>
              <h1 className="text-3xl font-light text-amber-500 flex items-center gap-3">
                <FlaskConical className="w-8 h-8" />
                Protein<span className="font-bold">Raga</span> Studio
              </h1>
              <p className="text-slate-500 text-sm mt-1">Scientific Sonification & Homology Analysis</p>
            </div>
            <div className="flex items-center gap-2">
              <input
                type="text"
                placeholder="UniProt ID (e.g. P53)"
                className="bg-slate-900 border border-slate-700 rounded px-3 py-1 text-sm w-48 focus:outline-none focus:border-amber-500"
                value={searchId}
                onChange={(e) => setSearchId(e.target.value)}
              />
              <button onClick={() => fetchProtein(searchId, 'A')} className="bg-slate-800 hover:bg-slate-700 p-1.5 rounded text-emerald-400"><Search className="w-4 h-4" /></button>
            </div>
          </div>

          {/* Main Grid */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 relative">
            {/* Slot A */}
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex gap-2"><span className="w-3 h-3 rounded-full bg-emerald-500"></span>Protein A</h2>
                <div className="flex gap-1"><button onClick={() => loadRandom('kinases', 'A')} className="text-[10px] px-2 py-1 bg-slate-800 rounded border border-slate-700 hover:bg-slate-700">Rand Kinase</button><button onClick={() => loadRandom('gpcrs', 'A')} className="text-[10px] px-2 py-1 bg-slate-800 rounded border border-slate-700 hover:bg-slate-700">Rand GPCR</button></div>
              </div>
              <div className="bg-slate-900 p-4 rounded border border-slate-800 relative min-h-[140px]">
                 {loading && <div className="absolute inset-0 bg-slate-900/80 flex items-center justify-center z-10"><RefreshCw className="w-6 h-6 animate-spin text-amber-500"/></div>}
                 <div className="flex justify-between mb-2"><div><div className="font-bold text-white truncate w-64">{dataA.name}</div><div className="text-xs text-amber-500 font-mono">{dataA.id}</div></div><span className="text-xs px-2 py-1 rounded border" style={{borderColor: ragaA.color, color: ragaA.color}}>{ragaA.name} <span className="opacity-50 text-[10px]">({ragaA.that})</span></span></div>
                 <div className="font-mono text-xs text-slate-500 break-all h-20 overflow-hidden relative">{dataA.seq.substring(0, 150)}...<div className="absolute inset-0" style={{background: `linear-gradient(90deg, transparent ${Math.max(0, currIdx * 1.5)}%, rgba(15,23,42,0.5) ${Math.max(0, currIdx * 1.5 + 5)}%)`}}></div></div>
              </div>
            </div>

            {/* Slot B */}
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex gap-2"><span className="w-3 h-3 rounded-full bg-amber-500"></span>Protein B</h2>
                <div className="flex gap-1"><button onClick={() => loadRandom('kinases', 'B')} className="text-[10px] px-2 py-1 bg-slate-800 rounded border border-slate-700 hover:bg-slate-700">Rand Kinase</button><button onClick={() => loadRandom('gpcrs', 'B')} className="text-[10px] px-2 py-1 bg-slate-800 rounded border border-slate-700 hover:bg-slate-700">Rand GPCR</button></div>
              </div>
              <div className="bg-slate-900 p-4 rounded border border-slate-800 relative min-h-[140px]">
                 {loading && <div className="absolute inset-0 bg-slate-900/80 flex items-center justify-center z-10"><RefreshCw className="w-6 h-6 animate-spin text-amber-500"/></div>}
                 <div className="flex justify-between mb-2"><div><div className="font-bold text-white truncate w-64">{dataB.name}</div><div className="text-xs text-amber-500 font-mono">{dataB.id}</div></div><span className="text-xs px-2 py-1 rounded border" style={{borderColor: ragaB.color, color: ragaB.color}}>{ragaB.name} <span className="opacity-50 text-[10px]">({ragaB.that})</span></span></div>
                 <div className="font-mono text-xs text-slate-500 break-all h-20 overflow-hidden">{dataB.seq.substring(0, 150)}...</div>
              </div>
            </div>
          </div>

          {/* Analysis Dashboard */}
          <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-slate-900 p-5 rounded border border-slate-800 flex flex-col items-center justify-center">
              <div className="text-4xl font-light text-white">{homology.percent}%</div>
              <div className="text-[10px] uppercase tracking-widest text-slate-500 mt-2">Audio Match Score</div>
            </div>
            <div className="flex items-center justify-center">
              <button onClick={playComparison} className={`w-full h-full rounded-xl flex flex-col items-center justify-center transition-all py-6 ${playing ? 'bg-rose-900/20 border border-rose-900 text-rose-500' : 'bg-gradient-to-br from-amber-600 to-amber-700 hover:scale-[1.02] text-white shadow-lg'}`}>
                {playing ? <Pause className="w-8 h-8 mb-2" /> : <Play className="w-8 h-8 mb-2" />}
                <span className="text-xs font-bold uppercase tracking-widest">{playing ? 'Stop' : 'Run Audio Comparison'}</span>
              </button>
            </div>
            <div className="bg-slate-900 p-5 rounded border border-slate-800 flex flex-col items-center justify-center">
              <div className={`text-2xl font-light ${ragaA.name === ragaB.name ? 'text-emerald-400' : 'text-rose-400'}`}>{ragaA.name === ragaB.name ? 'CONSONANT' : 'DISSONANT'}</div>
              <div className="text-[10px] uppercase tracking-widest text-slate-500 mt-2">Raga Alignment</div>
            </div>
          </div>

          {/* Science Panel Toggle */}
          <div className="mt-8 pt-6 border-t border-slate-800">
            <button onClick={() => setShowScience(!showScience)} className="flex items-center gap-2 text-xs uppercase tracking-widest text-slate-500 hover:text-amber-500 transition-colors mb-4">
              <Info className="w-4 h-4" /> The Science Behind
            </button>

            {showScience && (
              <div className="bg-slate-900 rounded-lg p-6 border border-slate-700 animate-in">
                <div className="flex justify-between items-start mb-4">
                  <h3 className="text-lg font-light text-white">Bio-Musical Logic</h3>
                  <button onClick={() => setShowScience(false)}><X className="w-4 h-4 text-slate-500 hover:text-white" /></button>
                </div>
                <div className="grid md:grid-cols-2 gap-6 text-sm text-slate-400">
                  <div>
                    <strong className="text-emerald-400 block mb-1">1. Physics: Mass Dictates Pitch</strong>
                    <p>Inverse relationship between mass and frequency. Lighter amino acids (Glycine) vibrate faster (High Octave). Heavy residues (Tryptophan) vibrate slower (Low Octave).</p>
                  </div>
                  <div>
                    <strong className="text-emerald-400 block mb-1">2. Chemistry: Personality Dictates Raga</strong>
                    <p>The protein's "mood" is determined by its dominant chemical property. <br/>• Hydrophobic = <strong>Bhairav</strong> (Grounded)<br/>• Charged = <strong>Marwa</strong> (Reactive)<br/>• Mixed = <strong>Yaman</strong> (Fluid)</p>
                  </div>
                  <div>
                    <strong className="text-emerald-400 block mb-1">3. Grammar: Paninian Texture</strong>
                    <p>Vocal articulation maps to molecular structure. Throat sounds (Kanthya) = Stable Core. Lip sounds (Osthya) = Surface Glides.</p>
                  </div>
                  <div>
                    <strong className="text-emerald-400 block mb-1">4. Musicology: What is That?</strong>
                    <p><strong>That</strong> (pronounced <em>Thaat</em>) is the "Parent Scale" or musical DNA family. It defines which specific notes (Shrutis) are permitted in the Raga.</p>
                  </div>
                </div>
              </div>
            )}
          </div>

        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ProteinRagaStudio />);
  </script>
</body>
</html>
