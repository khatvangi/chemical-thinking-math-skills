<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture 22: Expectation, Variance, and Error | Chemical Thinking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,400;9..144,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161f;
            --text-primary: #e8e6e3;
            --text-secondary: #a0a0a0;
            --text-muted: #6b6b6b;
            --accent-teal: #14b8a6;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
        }

        .lecture-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .nav-link:hover { color: var(--accent-teal); }

        .primitive-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(20, 184, 166, 0.3);
            text-decoration: none;
            transition: all 0.3s;
        }

        .primitive-link:hover {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(139, 92, 246, 0.2));
            border-color: var(--accent-teal);
        }

        .primitive-badge {
            background: var(--accent-teal);
            color: var(--bg-primary);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .primitive-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .lecture-header {
            text-align: center;
            padding: 4rem 2rem 3rem;
            background: linear-gradient(180deg, var(--bg-secondary), var(--bg-primary));
        }

        .lecture-number {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-teal);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .lecture-title {
            font-family: 'Fraunces', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .lecture-subtitle {
            color: var(--text-secondary);
            font-size: 1.25rem;
            font-style: italic;
        }

        main {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        section { margin-bottom: 4rem; }

        h2 {
            font-family: 'Fraunces', serif;
            font-size: 1.75rem;
            color: var(--accent-teal);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 2rem 0 1rem;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--accent-cyan);
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        strong { color: var(--text-primary); }

        .hook-section {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(20, 184, 166, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.95rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        th {
            background: var(--bg-secondary);
            color: var(--accent-teal);
            font-weight: 600;
        }

        tr:hover { background: rgba(20, 184, 166, 0.05); }
        td { color: var(--text-secondary); }

        .visual-container {
            background: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .visual-title {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .visual-canvas {
            width: 100%;
            height: 400px;
            background: var(--bg-primary);
            border-radius: 8px;
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bg-tertiary);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .control-group input[type="range"] {
            width: 150px;
            accent-color: var(--accent-teal);
        }

        .control-group input[type="number"] {
            width: 80px;
            padding: 0.4rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .control-group select {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 6px;
        }

        .control-group button {
            padding: 0.5rem 1rem;
            background: var(--accent-teal);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .control-group button:hover { background: var(--accent-cyan); }

        .value-display {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-teal);
            font-size: 0.9rem;
        }

        .formula-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-teal);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .formula-box .katex { font-size: 1.2rem; }

        .definition {
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid rgba(20, 184, 166, 0.3);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.5rem 0;
        }

        .definition-term {
            color: var(--accent-teal);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .key-insight {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.15), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--accent-teal);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .key-insight::before {
            content: "Key Insight";
            display: block;
            color: var(--accent-teal);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.5rem 0;
        }

        .warning::before {
            content: "Common Mistake";
            display: block;
            color: var(--accent-red);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        ul, ol {
            margin: 1rem 0 1rem 1.5rem;
            color: var(--text-secondary);
        }

        li { margin-bottom: 0.5rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            color: var(--accent-teal);
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .result-box {
            background: var(--bg-card);
            border: 2px solid var(--accent-teal);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            color: var(--accent-teal);
        }

        footer {
            text-align: center;
            padding: 3rem 2rem;
            border-top: 1px solid var(--bg-tertiary);
            color: var(--text-muted);
        }

        .notebook-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--accent-teal);
            color: var(--bg-primary);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .notebook-link:hover {
            background: var(--accent-cyan);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .lecture-title { font-size: 2rem; }
            .controls { flex-direction: column; }
            main { padding: 2rem 1rem; }
        }
    
        /* Course Navigation */
        .course-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-subtle, #2a2a35);
            padding: 0.75rem 1.5rem;
            margin: 0 -1.5rem 2rem;
        }
        .course-nav-inner {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .course-nav a {
            color: var(--text-secondary, #a8a5a0);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }
        .course-nav a:hover {
            color: var(--accent-teal, #14b8a6);
        }
        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-breadcrumb .sep {
            color: var(--text-muted, #6b6965);
        }
        .nav-course-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: #14b8a6;
            background: rgba(20, 184, 166, 0.15);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
        }
        .nav-arrows {
            display: flex;
            gap: 1rem;
        }
        .nav-arrows a {
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
        }
        .nav-arrows a:hover {
            background: rgba(20, 184, 166, 0.15);
        }

    </style>
</head>
<body>
    <nav class="course-nav">
        <div class="course-nav-inner">
            <div class="nav-breadcrumb">
                <a href="../../chem291/">CHEM 291</a>
                <span class="sep">/</span>
                <a href="../all-lectures.html">Lectures</a>
                <span class="sep">/</span>
                <span class="nav-course-badge">L22</span>
            </div>
            <div class="nav-arrows">
                <a href="../21-distributions/">← Prev</a>
                <a href="../23-dimensions/">Next →</a>
            </div>
        </div>
    </nav>

    <nav class="lecture-nav">
        <a href="../all-lectures.html" class="nav-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            All Lectures
        </a>
        <a href="../../primitives/spread.html" class="primitive-link">
            <span class="primitive-badge">SPREAD</span>
            <span class="primitive-text">Explore the Primitive</span>
        </a>
    </nav>

    <header class="lecture-header">
        <div class="lecture-number">LECTURE 22</div>
        <h1 class="lecture-title">Expectation, Variance, and Error</h1>
        <p class="lecture-subtitle">The gap between calculation and observation</p>
    </header>

    <main>
        <!-- Hook -->
        <div class="hook-section">
            <h2 style="border: none; padding: 0; margin-bottom: 1rem;">The Hook</h2>
            <p>You measure the C-C bond length in ethane. Ten measurements:</p>
            <p style="font-family: 'JetBrains Mono', monospace; color: var(--accent-cyan);">
                1.532, 1.528, 1.535, 1.530, 1.527, 1.534, 1.529, 1.531, 1.533, 1.528 A
            </p>
            <p><strong>Questions:</strong> What is THE bond length? How confident are you?</p>
            <p><strong>The uncomfortable answer:</strong> There is no single "true" value you can access. Every measurement has uncertainty. The best you can do is characterize the distribution of possible values.</p>
        </div>

        <!-- Fundamental Distinction -->
        <section>
            <h2>The Fundamental Distinction</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">-13.6 eV</div>
                    <div class="stat-label">Calculated (exact in model)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">-13.598 +/- 0.002</div>
                    <div class="stat-label">Observed (uncertain)</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr><th>Source</th><th>Type</th><th>Reducible?</th></tr>
                </thead>
                <tbody>
                    <tr><td>Instrument precision</td><td>Systematic/Random</td><td>Partially</td></tr>
                    <tr><td>Environmental fluctuation</td><td>Random</td><td>Partially</td></tr>
                    <tr><td>Sampling variation</td><td>Random</td><td>With more data</td></tr>
                    <tr><td>Quantum uncertainty</td><td>Fundamental</td><td>No</td></tr>
                    <tr><td>Model approximation</td><td>Systematic</td><td>With better theory</td></tr>
                </tbody>
            </table>
        </section>

        <!-- Sample Mean Demo -->
        <section>
            <h2>Sample Mean vs Population Mean</h2>
            <p>The sample mean x estimates the true mean mu. With more samples, our estimate becomes more precise.</p>

            <div class="visual-container">
                <div class="visual-title">Sampling from a Normal Distribution</div>
                <canvas id="samplingCanvas" class="visual-canvas"></canvas>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="sampleMean">-</div>
                        <div class="stat-label">Sample Mean x</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sampleStd">-</div>
                        <div class="stat-label">Sample Std s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stdError">-</div>
                        <div class="stat-label">Std Error SE</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ciContains">-</div>
                        <div class="stat-label">95% CI contains mu?</div>
                    </div>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label>True mean mu:</label>
                        <input type="range" id="trueMu" min="0" max="10" step="0.5" value="5">
                        <span class="value-display" id="trueMuValue">5</span>
                    </div>
                    <div class="control-group">
                        <label>True std sigma:</label>
                        <input type="range" id="trueSigma" min="0.5" max="3" step="0.25" value="1">
                        <span class="value-display" id="trueSigmaValue">1</span>
                    </div>
                    <div class="control-group">
                        <label>Sample size n:</label>
                        <select id="sampleSize">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button id="resampleBtn">Take New Sample</button>
                    </div>
                </div>
            </div>

            <div class="key-insight">
                <p><strong>Standard Error = s/sqrt(n)</strong></p>
                <p>More samples reduce SE, making the mean estimate more precise. The 95% CI should contain mu about 95% of the time.</p>
            </div>
        </section>

        <!-- Expectation and Variance -->
        <section>
            <h2>Expectation and Variance</h2>

            <div class="formula-box">
                <p><strong>Expectation (Mean):</strong></p>
                $$\langle X \rangle = \sum_i x_i P(x_i) \quad \text{or} \quad \int x \, f(x) \, dx$$
            </div>

            <div class="formula-box">
                <p><strong>Variance:</strong></p>
                $$\sigma^2 = \langle (X - \mu)^2 \rangle = \langle X^2 \rangle - \langle X \rangle^2$$
            </div>

            <h4>Example: Fair Die</h4>
            <p>X = number rolled</p>
            <ul>
                <li>E[X] = (1+2+3+4+5+6)/6 = <strong>3.5</strong> (but you can never roll 3.5!)</li>
                <li>E[X^2] = (1+4+9+16+25+36)/6 = 15.17</li>
                <li>Var(X) = 15.17 - 12.25 = <strong>2.92</strong></li>
                <li>sigma = <strong>1.71</strong></li>
            </ul>
        </section>

        <!-- Error Propagation -->
        <section>
            <h2>Error Propagation</h2>

            <div class="formula-box">
                <p><strong>General Formula</strong> (independent uncertainties):</p>
                $$\delta f = \sqrt{\left(\frac{\partial f}{\partial x}\right)^2 \delta x^2 + \left(\frac{\partial f}{\partial y}\right)^2 \delta y^2 + \cdots}$$
            </div>

            <div class="visual-container">
                <div class="visual-title">Error Propagation Calculator</div>
                <div class="controls" style="border-top: none; padding-top: 0;">
                    <div class="control-group">
                        <label>Operation:</label>
                        <select id="operation">
                            <option value="add">f = x + y</option>
                            <option value="subtract">f = x - y</option>
                            <option value="multiply">f = x * y</option>
                            <option value="divide">f = x / y</option>
                            <option value="power">f = x^n</option>
                        </select>
                    </div>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label>x =</label>
                        <input type="number" id="xVal" value="10" step="0.1">
                    </div>
                    <div class="control-group">
                        <label>+/- delta x =</label>
                        <input type="number" id="dxVal" value="0.5" step="0.01">
                    </div>
                    <div class="control-group">
                        <label>y =</label>
                        <input type="number" id="yVal" value="5" step="0.1">
                    </div>
                    <div class="control-group">
                        <label>+/- delta y =</label>
                        <input type="number" id="dyVal" value="0.2" step="0.01">
                    </div>
                    <div class="control-group">
                        <label>n (for power) =</label>
                        <input type="number" id="nPow" value="2" step="0.5">
                    </div>
                </div>
                <div class="result-box">
                    <p id="propagationFormula" style="margin-bottom: 0.5rem; color: var(--text-muted);"></p>
                    <div class="result-value" id="propagationResult">-</div>
                    <p id="relativeError" style="margin-top: 0.5rem; color: var(--text-muted);"></p>
                </div>
            </div>

            <h3>Common Cases</h3>
            <table>
                <thead>
                    <tr><th>Operation</th><th>Formula</th></tr>
                </thead>
                <tbody>
                    <tr><td>f = x +/- y</td><td>delta f = sqrt(delta x^2 + delta y^2)</td></tr>
                    <tr><td>f = x * y or x/y</td><td>delta f/f = sqrt((delta x/x)^2 + (delta y/y)^2)</td></tr>
                    <tr><td>f = x^n</td><td>delta f/f = |n| * delta x/x</td></tr>
                    <tr><td>f = e^x</td><td>delta f = |f| * delta x</td></tr>
                    <tr><td>f = ln(x)</td><td>delta f = delta x / x</td></tr>
                </tbody>
            </table>

            <div class="warning">
                <p><strong>Adding uncertainties linearly is WRONG!</strong></p>
                <p>delta(x+y) != delta x + delta y</p>
                <p>delta(x+y) = sqrt(delta x^2 + delta y^2) (add in quadrature)</p>
            </div>
        </section>

        <!-- Monte Carlo -->
        <section>
            <h2>Monte Carlo Error Propagation</h2>
            <p>When formulas get complicated, simulate! Generate random samples and see the distribution of f.</p>

            <div class="visual-container">
                <div class="visual-title">Monte Carlo: f = x^2/y with x = 4.0 +/- 0.2, y = 2.0 +/- 0.1</div>
                <canvas id="mcCanvas" class="visual-canvas" style="height: 350px;"></canvas>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="mcMean">-</div>
                        <div class="stat-label">MC Mean</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mcStd">-</div>
                        <div class="stat-label">MC Std</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticVal">-</div>
                        <div class="stat-label">Analytical f</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticErr">-</div>
                        <div class="stat-label">Analytical delta f</div>
                    </div>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label>Number of MC samples:</label>
                        <select id="mcSamples">
                            <option value="1000">1,000</option>
                            <option value="10000" selected>10,000</option>
                            <option value="100000">100,000</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button id="runMC">Run Monte Carlo</button>
                    </div>
                </div>
            </div>

            <div class="key-insight">
                <p>Monte Carlo naturally handles non-linear functions, correlated uncertainties, and non-Gaussian distributions.</p>
            </div>
        </section>

        <!-- Weighted Averages -->
        <section>
            <h2>Weighted Averages</h2>
            <p>When measurements have different precisions, weight by 1/sigma^2.</p>

            <div class="formula-box">
                $$\bar{x}_w = \frac{\sum_i w_i x_i}{\sum_i w_i} \quad \text{where } w_i = \frac{1}{\sigma_i^2}$$
            </div>

            <div class="visual-container">
                <div class="visual-title">Weighted Average Calculator</div>
                <canvas id="weightedCanvas" class="visual-canvas" style="height: 300px;"></canvas>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="weightedAvg">-</div>
                        <div class="stat-label">Weighted Avg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weightedErr">-</div>
                        <div class="stat-label">Uncertainty</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="simpleAvg">-</div>
                        <div class="stat-label">Simple Avg</div>
                    </div>
                </div>
            </div>

            <p>The more precise measurement dominates the weighted average!</p>
        </section>

        <!-- Summary -->
        <section>
            <h2>Summary</h2>

            <table>
                <thead>
                    <tr><th>Concept</th><th>Symbol</th><th>Meaning</th></tr>
                </thead>
                <tbody>
                    <tr><td>Expectation</td><td>E[X] or mu</td><td>Probability-weighted average</td></tr>
                    <tr><td>Variance</td><td>sigma^2</td><td>E[(X - mu)^2]</td></tr>
                    <tr><td>Standard deviation</td><td>sigma</td><td>sqrt(Var)</td></tr>
                    <tr><td>Standard error</td><td>SE</td><td>sigma/sqrt(n)</td></tr>
                </tbody>
            </table>

            <div class="key-insight">
                <p><strong>Every measurement is uncertain.</strong> Reporting a value without uncertainty is incomplete. Understanding error propagation connects calculated predictions to experimental reality.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>Chemical Thinking | Lecture 22: Expectation, Variance, and Error</p>
        <p style="margin-top: 0.5rem; font-size: 0.85rem;">SPREAD Primitive — The gap between calculation and observation</p>
        <a href="../../notebooks/Lecture_22_Error.jl" class="notebook-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>
            Open Pluto Notebook
        </a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });
        });

        function resizeCanvas(canvas) {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width - 48;
            canvas.height = parseInt(canvas.style.height) || 400;
        }

        // Box-Muller transform for normal random
        function randn() {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        // ========== Sampling Demo ==========
        const samplingCanvas = document.getElementById('samplingCanvas');
        const samplingCtx = samplingCanvas.getContext('2d');
        let samples = [];

        function updateSampling() {
            const mu = parseFloat(document.getElementById('trueMu').value);
            const sigma = parseFloat(document.getElementById('trueSigma').value);
            const n = parseInt(document.getElementById('sampleSize').value);

            document.getElementById('trueMuValue').textContent = mu;
            document.getElementById('trueSigmaValue').textContent = sigma;

            // Generate samples
            samples = [];
            for (let i = 0; i < n; i++) {
                samples.push(mu + sigma * randn());
            }

            // Calculate statistics
            const xBar = samples.reduce((a, b) => a + b, 0) / n;
            const variance = samples.reduce((a, b) => a + (b - xBar) ** 2, 0) / (n - 1);
            const s = Math.sqrt(variance);
            const SE = s / Math.sqrt(n);

            const ciLower = xBar - 2 * SE;
            const ciUpper = xBar + 2 * SE;
            const ciContains = mu >= ciLower && mu <= ciUpper;

            document.getElementById('sampleMean').textContent = xBar.toFixed(3);
            document.getElementById('sampleStd').textContent = s.toFixed(3);
            document.getElementById('stdError').textContent = SE.toFixed(3);
            document.getElementById('ciContains').textContent = ciContains ? 'Yes' : 'No';
            document.getElementById('ciContains').style.color = ciContains ? '#10b981' : '#ef4444';

            drawSampling(mu, sigma, samples, xBar, SE);
        }

        function drawSampling(mu, sigma, samples, xBar, SE) {
            resizeCanvas(samplingCanvas);
            const w = samplingCanvas.width;
            const h = samplingCanvas.height;
            const padding = 60;

            samplingCtx.fillStyle = '#0a0a0f';
            samplingCtx.fillRect(0, 0, w, h);

            // Determine range
            const minVal = Math.min(...samples, mu - 3 * sigma);
            const maxVal = Math.max(...samples, mu + 3 * sigma);
            const range = maxVal - minVal;

            // Draw histogram
            const numBins = 15;
            const binWidth = range / numBins;
            const bins = new Array(numBins).fill(0);

            samples.forEach(s => {
                const binIdx = Math.min(numBins - 1, Math.floor((s - minVal) / binWidth));
                bins[binIdx]++;
            });

            const maxCount = Math.max(...bins);
            const barWidth = (w - 2 * padding) / numBins;

            samplingCtx.fillStyle = 'rgba(20, 184, 166, 0.6)';
            for (let i = 0; i < numBins; i++) {
                const barHeight = (bins[i] / maxCount) * (h - 2 * padding - 40);
                const x = padding + i * barWidth;
                const y = h - padding - barHeight;
                samplingCtx.fillRect(x, y, barWidth - 2, barHeight);
            }

            // Draw true mu line
            const muX = padding + ((mu - minVal) / range) * (w - 2 * padding);
            samplingCtx.strokeStyle = '#ef4444';
            samplingCtx.lineWidth = 3;
            samplingCtx.beginPath();
            samplingCtx.moveTo(muX, padding);
            samplingCtx.lineTo(muX, h - padding);
            samplingCtx.stroke();

            // Draw sample mean line
            const xBarX = padding + ((xBar - minVal) / range) * (w - 2 * padding);
            samplingCtx.strokeStyle = '#3b82f6';
            samplingCtx.lineWidth = 3;
            samplingCtx.setLineDash([8, 4]);
            samplingCtx.beginPath();
            samplingCtx.moveTo(xBarX, padding);
            samplingCtx.lineTo(xBarX, h - padding);
            samplingCtx.stroke();
            samplingCtx.setLineDash([]);

            // Draw 95% CI
            const ciLowerX = padding + ((xBar - 2 * SE - minVal) / range) * (w - 2 * padding);
            const ciUpperX = padding + ((xBar + 2 * SE - minVal) / range) * (w - 2 * padding);
            samplingCtx.fillStyle = 'rgba(59, 130, 246, 0.2)';
            samplingCtx.fillRect(ciLowerX, padding, ciUpperX - ciLowerX, h - 2 * padding);

            // Labels
            samplingCtx.fillStyle = '#e8e6e3';
            samplingCtx.font = '14px Inter';
            samplingCtx.textAlign = 'center';
            samplingCtx.fillText('Value', w / 2, h - 15);

            // Legend
            samplingCtx.textAlign = 'left';
            samplingCtx.font = '12px Inter';
            samplingCtx.fillStyle = '#ef4444';
            samplingCtx.fillText('True mu', w - 120, 30);
            samplingCtx.fillStyle = '#3b82f6';
            samplingCtx.fillText('Sample mean', w - 120, 50);
        }

        document.getElementById('trueMu').addEventListener('input', updateSampling);
        document.getElementById('trueSigma').addEventListener('input', updateSampling);
        document.getElementById('sampleSize').addEventListener('change', updateSampling);
        document.getElementById('resampleBtn').addEventListener('click', updateSampling);

        // ========== Error Propagation Calculator ==========
        function updatePropagation() {
            const op = document.getElementById('operation').value;
            const x = parseFloat(document.getElementById('xVal').value);
            const dx = parseFloat(document.getElementById('dxVal').value);
            const y = parseFloat(document.getElementById('yVal').value);
            const dy = parseFloat(document.getElementById('dyVal').value);
            const n = parseFloat(document.getElementById('nPow').value);

            let f, df, formula;

            if (op === 'add') {
                f = x + y;
                df = Math.sqrt(dx * dx + dy * dy);
                formula = 'df = sqrt(dx^2 + dy^2)';
            } else if (op === 'subtract') {
                f = x - y;
                df = Math.sqrt(dx * dx + dy * dy);
                formula = 'df = sqrt(dx^2 + dy^2)';
            } else if (op === 'multiply') {
                f = x * y;
                const relErr = Math.sqrt((dx / x) ** 2 + (dy / y) ** 2);
                df = f * relErr;
                formula = 'df/f = sqrt((dx/x)^2 + (dy/y)^2)';
            } else if (op === 'divide') {
                f = x / y;
                const relErr = Math.sqrt((dx / x) ** 2 + (dy / y) ** 2);
                df = Math.abs(f) * relErr;
                formula = 'df/f = sqrt((dx/x)^2 + (dy/y)^2)';
            } else {
                f = Math.pow(x, n);
                const relErr = Math.abs(n) * dx / x;
                df = Math.abs(f) * relErr;
                formula = 'df/f = |n| * dx/x';
            }

            document.getElementById('propagationFormula').textContent = formula;
            document.getElementById('propagationResult').textContent =
                `f = ${f.toFixed(4)} +/- ${df.toFixed(4)}`;
            document.getElementById('relativeError').textContent =
                `Relative uncertainty: ${(100 * df / Math.abs(f)).toFixed(2)}%`;
        }

        ['operation', 'xVal', 'dxVal', 'yVal', 'dyVal', 'nPow'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePropagation);
            document.getElementById(id).addEventListener('change', updatePropagation);
        });

        // ========== Monte Carlo ==========
        const mcCanvas = document.getElementById('mcCanvas');
        const mcCtx = mcCanvas.getContext('2d');

        function runMonteCarlo() {
            const n = parseInt(document.getElementById('mcSamples').value);

            const x0 = 4.0, dx = 0.2;
            const y0 = 2.0, dy = 0.1;

            const fSamples = [];
            for (let i = 0; i < n; i++) {
                const x = x0 + dx * randn();
                const y = y0 + dy * randn();
                fSamples.push((x * x) / y);
            }

            const mean = fSamples.reduce((a, b) => a + b, 0) / n;
            const variance = fSamples.reduce((a, b) => a + (b - mean) ** 2, 0) / (n - 1);
            const std = Math.sqrt(variance);

            // Analytical
            const fAnalytic = (x0 * x0) / y0;
            const dfAnalytic = fAnalytic * Math.sqrt((2 * dx / x0) ** 2 + (dy / y0) ** 2);

            document.getElementById('mcMean').textContent = mean.toFixed(3);
            document.getElementById('mcStd').textContent = std.toFixed(3);
            document.getElementById('analyticVal').textContent = fAnalytic.toFixed(3);
            document.getElementById('analyticErr').textContent = dfAnalytic.toFixed(3);

            drawMC(fSamples, mean, fAnalytic);
        }

        function drawMC(samples, mean, analytic) {
            resizeCanvas(mcCanvas);
            mcCanvas.height = 350;
            const w = mcCanvas.width;
            const h = mcCanvas.height;
            const padding = 50;

            mcCtx.fillStyle = '#0a0a0f';
            mcCtx.fillRect(0, 0, w, h);

            const minVal = Math.min(...samples);
            const maxVal = Math.max(...samples);
            const range = maxVal - minVal;

            const numBins = 50;
            const binWidth = range / numBins;
            const bins = new Array(numBins).fill(0);

            samples.forEach(s => {
                const binIdx = Math.min(numBins - 1, Math.floor((s - minVal) / binWidth));
                bins[binIdx]++;
            });

            const maxCount = Math.max(...bins);
            const barW = (w - 2 * padding) / numBins;

            mcCtx.fillStyle = 'rgba(139, 92, 246, 0.7)';
            for (let i = 0; i < numBins; i++) {
                const barHeight = (bins[i] / maxCount) * (h - 2 * padding - 20);
                const x = padding + i * barW;
                const y = h - padding - barHeight;
                mcCtx.fillRect(x, y, barW - 1, barHeight);
            }

            // Mean line
            const meanX = padding + ((mean - minVal) / range) * (w - 2 * padding);
            mcCtx.strokeStyle = '#ef4444';
            mcCtx.lineWidth = 3;
            mcCtx.beginPath();
            mcCtx.moveTo(meanX, padding);
            mcCtx.lineTo(meanX, h - padding);
            mcCtx.stroke();

            // Analytic line
            const analyticX = padding + ((analytic - minVal) / range) * (w - 2 * padding);
            mcCtx.strokeStyle = '#3b82f6';
            mcCtx.lineWidth = 2;
            mcCtx.setLineDash([5, 5]);
            mcCtx.beginPath();
            mcCtx.moveTo(analyticX, padding);
            mcCtx.lineTo(analyticX, h - padding);
            mcCtx.stroke();
            mcCtx.setLineDash([]);

            // Label
            mcCtx.fillStyle = '#e8e6e3';
            mcCtx.font = '14px Inter';
            mcCtx.textAlign = 'center';
            mcCtx.fillText('f = x^2/y', w / 2, h - 10);
        }

        document.getElementById('runMC').addEventListener('click', runMonteCarlo);

        // ========== Weighted Average ==========
        const weightedCanvas = document.getElementById('weightedCanvas');
        const weightedCtx = weightedCanvas.getContext('2d');

        function drawWeighted() {
            resizeCanvas(weightedCanvas);
            weightedCanvas.height = 300;
            const w = weightedCanvas.width;
            const h = weightedCanvas.height;
            const padding = 50;

            weightedCtx.fillStyle = '#0a0a0f';
            weightedCtx.fillRect(0, 0, w, h);

            const data = [
                { x: 1.23, sigma: 0.05 },
                { x: 1.45, sigma: 0.15 },
                { x: 1.30, sigma: 0.08 }
            ];

            // Calculate weighted average
            let sumW = 0, sumWx = 0;
            data.forEach(d => {
                const w = 1 / (d.sigma * d.sigma);
                sumW += w;
                sumWx += w * d.x;
            });
            const xWeighted = sumWx / sumW;
            const sigmaWeighted = 1 / Math.sqrt(sumW);

            const xSimple = data.reduce((a, b) => a + b.x, 0) / 3;

            document.getElementById('weightedAvg').textContent = xWeighted.toFixed(3);
            document.getElementById('weightedErr').textContent = '+/- ' + sigmaWeighted.toFixed(3);
            document.getElementById('simpleAvg').textContent = xSimple.toFixed(3);

            // Draw
            const minVal = 1.0, maxVal = 1.7;
            const range = maxVal - minVal;

            const toX = v => padding + ((v - minVal) / range) * (w - 2 * padding);
            const centerY = h / 2;

            // Draw points with error bars
            data.forEach((d, i) => {
                const x = toX(d.x);
                const y = centerY - 60 + i * 60;

                weightedCtx.strokeStyle = '#3b82f6';
                weightedCtx.lineWidth = 2;
                weightedCtx.beginPath();
                weightedCtx.moveTo(toX(d.x - d.sigma), y);
                weightedCtx.lineTo(toX(d.x + d.sigma), y);
                weightedCtx.stroke();

                weightedCtx.fillStyle = '#3b82f6';
                weightedCtx.beginPath();
                weightedCtx.arc(x, y, 8, 0, 2 * Math.PI);
                weightedCtx.fill();

                weightedCtx.fillStyle = '#a0a0a0';
                weightedCtx.font = '11px JetBrains Mono';
                weightedCtx.textAlign = 'right';
                weightedCtx.fillText(`${d.x} +/- ${d.sigma}`, padding - 10, y + 4);
            });

            // Weighted average line
            weightedCtx.strokeStyle = '#ef4444';
            weightedCtx.lineWidth = 3;
            weightedCtx.beginPath();
            weightedCtx.moveTo(toX(xWeighted), padding);
            weightedCtx.lineTo(toX(xWeighted), h - padding);
            weightedCtx.stroke();

            // Simple average line
            weightedCtx.strokeStyle = '#10b981';
            weightedCtx.lineWidth = 2;
            weightedCtx.setLineDash([5, 5]);
            weightedCtx.beginPath();
            weightedCtx.moveTo(toX(xSimple), padding);
            weightedCtx.lineTo(toX(xSimple), h - padding);
            weightedCtx.stroke();
            weightedCtx.setLineDash([]);

            // Legend
            weightedCtx.font = '12px Inter';
            weightedCtx.textAlign = 'left';
            weightedCtx.fillStyle = '#ef4444';
            weightedCtx.fillText('Weighted avg', w - 130, 30);
            weightedCtx.fillStyle = '#10b981';
            weightedCtx.fillText('Simple avg', w - 130, 50);
        }

        // Initialize
        window.addEventListener('resize', function() {
            updateSampling();
            runMonteCarlo();
            drawWeighted();
        });

        updateSampling();
        updatePropagation();
        runMonteCarlo();
        drawWeighted();
    </script>
</body>
</html>
