<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture 3: Counting Things | Chemical Thinking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --text-primary: #e8e6e3;
            --text-secondary: #a8a5a0;
            --text-muted: #6b6966;
            --accent-gold: #d4a574;
            --accent-purple: #9d8cd9;
            --accent-blue: #7db3dc;
            --accent-green: #8bc49d;
            --accent-red: #dc8b8b;
            --border-color: #2a2a35;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 17px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Header */
        header {
            padding: 4rem 0 3rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 3rem;
        }

        .lecture-number {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-purple);
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 2.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.3rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .primitive-tag {
            display: inline-block;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            margin-top: 1.5rem;
        }

        /* Sections */
        section {
            margin-bottom: 4rem;
        }

        h2 {
            font-family: 'Fraunces', serif;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--accent-gold);
        }

        h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 2rem 0 1rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1.2rem;
            color: var(--text-secondary);
        }

        strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Hook questions */
        .hook-box {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-purple);
            padding: 1.5rem 2rem;
            margin: 2rem 0;
            border-radius: 0 8px 8px 0;
        }

        .hook-box p {
            margin-bottom: 0.8rem;
        }

        .hook-box p:last-child {
            margin-bottom: 0;
        }

        /* Definition boxes */
        .definition-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-blue);
            padding: 1.5rem 2rem;
            margin: 2rem 0;
            border-radius: 8px;
        }

        .definition-box .label {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-blue);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        /* Principle boxes */
        .principle-box {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--accent-gold);
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 8px;
            text-align: center;
        }

        .principle-box p {
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.95rem;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-secondary);
            color: var(--accent-gold);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        td {
            color: var(--text-secondary);
        }

        tr:hover td {
            background: var(--bg-secondary);
        }

        /* Code blocks */
        code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--accent-purple);
        }

        /* Visual containers */
        .visual-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .visual-title {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-purple);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .controls.no-border {
            border-top: none;
            padding-top: 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        input[type="range"] {
            width: 150px;
            accent-color: var(--accent-gold);
        }

        select {
            font-family: 'JetBrains Mono', monospace;
            padding: 0.4rem 0.8rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .value-display {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-gold);
            font-size: 1rem;
            min-width: 60px;
            text-align: center;
        }

        button {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--accent-purple);
            color: var(--bg-primary);
        }

        button.active {
            background: var(--accent-purple);
            color: var(--bg-primary);
        }

        /* Info displays */
        .info-display {
            background: var(--bg-tertiary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            text-align: center;
        }

        .info-display .result {
            color: var(--accent-gold);
            font-size: 1.2rem;
            margin-top: 0.5rem;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0 1.5rem 1.5rem;
            color: var(--text-secondary);
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Pascal's Triangle display */
        .pascal-display {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            line-height: 2;
            color: var(--text-secondary);
            overflow-x: auto;
            padding: 1rem;
        }

        .pascal-row {
            white-space: nowrap;
        }

        .pascal-entry {
            display: inline-block;
            min-width: 40px;
            padding: 0.2rem 0.4rem;
            margin: 0.1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pascal-entry:hover {
            background: var(--accent-purple);
            color: var(--bg-primary);
        }

        .pascal-entry.highlighted {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        /* Benzene visualization */
        .isomer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .isomer-card {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .isomer-card:hover {
            border-color: var(--accent-green);
        }

        .isomer-card.active {
            border: 2px solid var(--accent-green);
        }

        .isomer-name {
            color: var(--accent-gold);
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .isomer-positions {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Exercises */
        .exercise-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }

        .exercise-box h4 {
            color: var(--accent-purple);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            justify-content: space-between;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 4rem;
        }

        .nav-links a {
            color: var(--accent-purple);
            text-decoration: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--accent-gold);
        }

        /* KaTeX adjustments */
        .katex {
            font-size: 1.1em;
        }

        .katex-display {
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .container {
                padding: 0 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            canvas {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="lecture-number">LECTURE 03</div>
            <h1>Counting Things</h1>
            <p class="subtitle">The primitive of multiplicity. How many?</p>
            <div class="primitive-tag">COLLECTION</div>
        </header>

        <!-- The Hook -->
        <section id="hook">
            <h2>The Hook</h2>

            <div class="hook-box">
                <p><strong>Question 1:</strong> You have 5 different reagent bottles. How many ways can you arrange them on a shelf?</p>
                <p><strong>Question 2:</strong> A protein has 100 amino acid positions. Each position can be one of 20 amino acids. How many possible sequences exist?</p>
                <p><strong>Question 3:</strong> Benzene has 6 equivalent positions. You want to substitute 2 of them with chlorine. How many dichlorobenzene isomers are there?</p>
            </div>

            <p>These questions share a structure: <em>counting configurations</em>.</p>
            <p>The numbers involved grow rapidly. Question 2 has more possible sequences than atoms in the observable universe.</p>
            <p>We need systematic methods.</p>
        </section>

        <!-- Recognition -->
        <section id="recognition">
            <h2>Recognition</h2>

            <div class="definition-box">
                <div class="label">THE PRIMITIVE</div>
                <p><strong>COLLECTION:</strong> "There are many."</p>
                <p>Before we can do anything with objects — arrange them, select them, distribute them — we must count them.</p>
            </div>

            <p>Counting is the foundation. The tools are:</p>
            <ul>
                <li>The multiplication principle</li>
                <li>Factorial</li>
                <li>Permutations</li>
                <li>Combinations</li>
            </ul>
        </section>

        <!-- Multiplication Principle -->
        <section id="multiplication-principle">
            <h2>The Multiplication Principle</h2>

            <p>The most fundamental counting rule.</p>

            <div class="principle-box">
                <p>If task A can be done in <em>m</em> ways, and for each way of doing A, task B can be done in <em>n</em> ways, then A followed by B can be done in <strong>m × n</strong> ways.</p>
            </div>

            <h3>Interactive: Decision Tree</h3>
            <p>Watch how choices multiply at each step.</p>

            <div class="visual-container">
                <div class="visual-title">[ MULTIPLICATION PRINCIPLE TREE ]</div>
                <canvas id="tree-canvas" width="700" height="400"></canvas>
                <div class="controls">
                    <div class="control-group">
                        <label>Choices per step</label>
                        <input type="range" id="tree-choices" min="2" max="4" value="3">
                        <span class="value-display" id="tree-choices-val">3</span>
                    </div>
                    <div class="control-group">
                        <label>Number of steps</label>
                        <input type="range" id="tree-steps" min="1" max="4" value="2">
                        <span class="value-display" id="tree-steps-val">2</span>
                    </div>
                </div>
                <div class="info-display">
                    <span id="tree-formula">3 × 3 = </span>
                    <span class="result" id="tree-result">9 outcomes</span>
                </div>
            </div>

            <h3>Examples</h3>
            <p><strong>License plates:</strong> 3 letters followed by 3 digits</p>
            <ul>
                <li>Letters: 26 choices each → 26³ = 17,576</li>
                <li>Digits: 10 choices each → 10³ = 1,000</li>
                <li>Total: 26³ × 10³ = 17,576,000</li>
            </ul>

            <p><strong>DNA sequences of length k:</strong></p>
            <p>Each position has 4 choices (A, T, G, C). For k positions: 4<sup>k</sup> sequences.</p>

            <p><strong>General formula:</strong> n choices at each of k positions → n<sup>k</sup> sequences.</p>
        </section>

        <!-- Factorial -->
        <section id="factorial">
            <h2>The Factorial</h2>

            <p>How many ways to arrange <em>n</em> distinct objects in a row?</p>

            <ul>
                <li>First position: n choices</li>
                <li>Second position: n − 1 remaining choices</li>
                <li>Third position: n − 2 remaining choices</li>
                <li>...</li>
                <li>Last position: 1 choice</li>
            </ul>

            <div class="definition-box">
                <div class="label">DEFINITION</div>
                <p>The <strong>factorial</strong> of a non-negative integer n is:</p>
                <p style="text-align: center; font-size: 1.2rem;">$$n! = n \times (n-1) \times (n-2) \times \cdots \times 2 \times 1$$</p>
                <p>with the convention that <strong>0! = 1</strong>.</p>
            </div>

            <h3>Why 0! = 1?</h3>
            <ol>
                <li><strong>Combinatorial:</strong> There is exactly one way to arrange zero objects: do nothing.</li>
                <li><strong>Recursive:</strong> We have n! = n × (n−1)!. Setting n = 1: 1! = 1 × 0!, so 0! = 1.</li>
                <li><strong>Gamma function:</strong> Γ(1) = 1, and Γ(n+1) = n! for positive integers.</li>
            </ol>

            <h3>Interactive: Factorial Calculator</h3>

            <div class="visual-container">
                <div class="visual-title">[ FACTORIAL VALUES ]</div>
                <div class="controls no-border">
                    <div class="control-group">
                        <label>n =</label>
                        <input type="range" id="fact-n" min="0" max="20" value="5">
                        <span class="value-display" id="fact-n-val">5</span>
                    </div>
                </div>
                <div class="info-display">
                    <div id="fact-expansion">5! = 5 × 4 × 3 × 2 × 1</div>
                    <div class="result" id="fact-result">= 120</div>
                </div>
            </div>

            <h3>Factorial Growth</h3>
            <p>Factorials grow faster than exponentials. 70! > 10<sup>100</sup> (a googol).</p>

            <div class="visual-container">
                <div class="visual-title">[ FACTORIAL GROWTH — LOG SCALE ]</div>
                <canvas id="factorial-canvas" width="700" height="350"></canvas>
                <div class="controls">
                    <div class="control-group">
                        <label>Max n</label>
                        <input type="range" id="fact-max" min="5" max="15" value="10">
                        <span class="value-display" id="fact-max-val">10</span>
                    </div>
                </div>
                <div class="info-display">
                    <span style="color: var(--accent-blue);">●</span> n! &nbsp;&nbsp;
                    <span style="color: var(--accent-red);">●</span> 2<sup>n</sup> &nbsp;&nbsp;
                    <span style="color: var(--accent-green);">●</span> 10<sup>n</sup>
                </div>
            </div>

            <h3>Stirling's Approximation</h3>
            <p>For large n:</p>
            <p style="text-align: center;">$$n! \approx \sqrt{2\pi n} \left(\frac{n}{e}\right)^n$$</p>
            <p>Or more simply: $$\ln(n!) \approx n\ln(n) - n$$</p>

            <table>
                <thead>
                    <tr><th>n</th><th>n!</th></tr>
                </thead>
                <tbody>
                    <tr><td>0</td><td>1</td></tr>
                    <tr><td>5</td><td>120</td></tr>
                    <tr><td>10</td><td>3,628,800</td></tr>
                    <tr><td>20</td><td>2.43 × 10<sup>18</sup></td></tr>
                    <tr><td>100</td><td>9.33 × 10<sup>157</sup></td></tr>
                </tbody>
            </table>
        </section>

        <!-- Permutations -->
        <section id="permutations">
            <h2>Permutations</h2>

            <p>A <strong>permutation</strong> is an arrangement of objects where <strong>order matters</strong>.</p>

            <div class="definition-box">
                <div class="label">PERMUTATIONS OF n TAKEN k</div>
                <p>From n distinct objects, the number of ways to select and arrange k of them:</p>
                <p style="text-align: center; font-size: 1.2rem;">$$P(n, k) = \frac{n!}{(n-k)!} = n \times (n-1) \times \cdots \times (n-k+1)$$</p>
            </div>

            <h3>Interactive: Permutation Calculator</h3>

            <div class="visual-container">
                <div class="visual-title">[ PERMUTATIONS P(n, k) ]</div>
                <div class="controls no-border">
                    <div class="control-group">
                        <label>n (total)</label>
                        <input type="range" id="perm-n" min="1" max="15" value="10">
                        <span class="value-display" id="perm-n-val">10</span>
                    </div>
                    <div class="control-group">
                        <label>k (arrange)</label>
                        <input type="range" id="perm-k" min="1" max="15" value="3">
                        <span class="value-display" id="perm-k-val">3</span>
                    </div>
                </div>
                <div class="info-display">
                    <div id="perm-formula">P(10, 3) = 10 × 9 × 8</div>
                    <div class="result" id="perm-result">= 720</div>
                </div>
            </div>

            <p><strong>Example:</strong> From 10 runners, how many ways to award gold, silver, bronze?</p>
            <p>P(10, 3) = 10 × 9 × 8 = 720</p>

            <h3>Permutations with Repetition</h3>
            <p>How many arrangements of the letters in MISSISSIPPI?</p>
            <ul>
                <li>11 letters total</li>
                <li>M: 1, I: 4, S: 4, P: 2</li>
            </ul>

            <p>The formula:</p>
            <p style="text-align: center;">$$\frac{n!}{n_1! \times n_2! \times \cdots \times n_k!}$$</p>

            <p>MISSISSIPPI: $\frac{11!}{1! \times 4! \times 4! \times 2!} = \frac{39,916,800}{1,152} = 34,650$</p>
        </section>

        <!-- Combinations -->
        <section id="combinations">
            <h2>Combinations</h2>

            <p>A <strong>combination</strong> is a selection of objects where <strong>order does not matter</strong>.</p>

            <div class="definition-box">
                <div class="label">COMBINATIONS OF n TAKEN k</div>
                <p>From n distinct objects, the number of ways to choose k of them:</p>
                <p style="text-align: center; font-size: 1.2rem;">$$\binom{n}{k} = \frac{n!}{k!(n-k)!}$$</p>
                <p style="text-align: center; color: var(--text-muted);">Read as "n choose k"</p>
            </div>

            <p><strong>Key insight:</strong> Each unordered selection of k objects can be arranged in k! ways. So:</p>
            <p style="text-align: center;">$$\binom{n}{k} = \frac{P(n,k)}{k!}$$</p>

            <h3>Interactive: Combination Calculator</h3>

            <div class="visual-container">
                <div class="visual-title">[ COMBINATIONS C(n, k) ]</div>
                <div class="controls no-border">
                    <div class="control-group">
                        <label>n (total)</label>
                        <input type="range" id="comb-n" min="1" max="20" value="10">
                        <span class="value-display" id="comb-n-val">10</span>
                    </div>
                    <div class="control-group">
                        <label>k (choose)</label>
                        <input type="range" id="comb-k" min="0" max="20" value="3">
                        <span class="value-display" id="comb-k-val">3</span>
                    </div>
                </div>
                <div class="info-display">
                    <div id="comb-formula">C(10, 3) = 10! / (3! × 7!)</div>
                    <div class="result" id="comb-result">= 120</div>
                    <div id="comb-symmetry" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                        Symmetry: C(10, 3) = C(10, 7) = 120
                    </div>
                </div>
            </div>

            <h3>Properties of Binomial Coefficients</h3>

            <p><strong>Symmetry:</strong> $\binom{n}{k} = \binom{n}{n-k}$</p>
            <p>Choosing k objects to include is equivalent to choosing n−k objects to exclude.</p>

            <p><strong>Pascal's Identity:</strong> $\binom{n}{k} = \binom{n-1}{k-1} + \binom{n-1}{k}$</p>
            <p>Each entry is the sum of two entries above it.</p>

            <p><strong>Sum of row n:</strong> $\displaystyle\sum_{k=0}^{n} \binom{n}{k} = 2^n$</p>
        </section>

        <!-- Pascal's Triangle -->
        <section id="pascal">
            <h2>Pascal's Triangle</h2>

            <div class="visual-container">
                <div class="visual-title">[ PASCAL'S TRIANGLE ]</div>
                <div class="controls no-border">
                    <div class="control-group">
                        <label>Rows</label>
                        <input type="range" id="pascal-rows" min="3" max="12" value="8">
                        <span class="value-display" id="pascal-rows-val">8</span>
                    </div>
                </div>
                <div id="pascal-display" class="pascal-display"></div>
                <div class="info-display">
                    <div id="pascal-info">Click any entry to see its identity</div>
                </div>
            </div>

            <h3>The Binomial Theorem</h3>
            <p style="text-align: center;">$$(x + y)^n = \sum_{k=0}^{n} \binom{n}{k} x^{n-k} y^k$$</p>

            <p><strong>Example:</strong> $(x + y)^4 = x^4 + 4x^3y + 6x^2y^2 + 4xy^3 + y^4$</p>
            <p>Coefficients: 1, 4, 6, 4, 1 — row 4 of Pascal's triangle.</p>
        </section>

        <!-- Summary Table -->
        <section id="summary">
            <h2>Counting Principles Summary</h2>

            <table>
                <thead>
                    <tr>
                        <th>Situation</th>
                        <th>Formula</th>
                        <th>When to use</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>n choices at each of k positions</td>
                        <td>n<sup>k</sup></td>
                        <td>Independent choices with replacement</td>
                    </tr>
                    <tr>
                        <td>Arrange n distinct objects</td>
                        <td>n!</td>
                        <td>All objects, order matters</td>
                    </tr>
                    <tr>
                        <td>Arrange k of n distinct objects</td>
                        <td>n!/(n−k)!</td>
                        <td>Subset, order matters</td>
                    </tr>
                    <tr>
                        <td>Arrange n with repetitions</td>
                        <td>n!/(n₁!n₂!···)</td>
                        <td>Identical objects present</td>
                    </tr>
                    <tr>
                        <td>Choose k of n objects</td>
                        <td>n!/[k!(n−k)!]</td>
                        <td>Subset, order doesn't matter</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Chemistry Connections -->
        <section id="chemistry">
            <h2>Chemistry Connections</h2>

            <h3>Counting Isomers</h3>
            <p>How many structural isomers of C₅H₁₂ (pentane)?</p>
            <p>Not a simple formula — requires enumerating distinct carbon skeletons:</p>
            <ol>
                <li>n-pentane: C-C-C-C-C (linear)</li>
                <li>isopentane: C-C-C(-C)-C (one branch)</li>
                <li>neopentane: C-C(-C)(-C)-C (two branches on same carbon)</li>
            </ol>
            <p>Answer: <strong>3 isomers</strong>.</p>

            <p>For larger alkanes, the count grows rapidly:</p>
            <ul>
                <li>C₁₀H₂₂: 75 isomers</li>
                <li>C₂₀H₄₂: 366,319 isomers</li>
                <li>C₄₀H₈₂: 62,481,801,147,341 isomers</li>
            </ul>

            <h3>Benzene Substitution Patterns</h3>
            <p>Benzene has 6 equivalent positions. Choose 2 for Cl.</p>
            <p>Naive count: $\binom{6}{2} = 15$</p>
            <p>But benzene has symmetry. Positions related by rotation/reflection give the same isomer.</p>

            <div class="visual-container">
                <div class="visual-title">[ BENZENE SUBSTITUTION ]</div>
                <canvas id="benzene-canvas" width="600" height="320"></canvas>
                <div class="controls">
                    <div class="control-group">
                        <label>Number of Cl</label>
                        <input type="range" id="benzene-ncl" min="0" max="6" value="2">
                        <span class="value-display" id="benzene-ncl-val">2</span>
                    </div>
                </div>
                <div class="info-display">
                    <div>Naive count: C(6, <span id="benzene-k">2</span>) = <span id="benzene-naive">15</span></div>
                    <div class="result">Distinct isomers: <span id="benzene-actual">3</span></div>
                </div>
                <div id="isomer-cards" class="isomer-info"></div>
            </div>

            <p>Actual distinct dichlorobenzene isomers:</p>
            <ol>
                <li><strong>ortho</strong> (1,2-): adjacent positions</li>
                <li><strong>meta</strong> (1,3-): one position apart</li>
                <li><strong>para</strong> (1,4-): opposite positions</li>
            </ol>
            <p>Answer: <strong>3 isomers</strong>. Symmetry reduces the count from 15 to 3.</p>

            <h3>Electron Configurations</h3>
            <p>How many ways to put electrons in orbitals?</p>

            <div class="visual-container">
                <div class="visual-title">[ ELECTRON MICROSTATES ]</div>
                <div class="controls no-border">
                    <div class="control-group">
                        <label>Subshell</label>
                        <select id="subshell-select">
                            <option value="s">s (2 spin-orbitals)</option>
                            <option value="p" selected>p (6 spin-orbitals)</option>
                            <option value="d">d (10 spin-orbitals)</option>
                            <option value="f">f (14 spin-orbitals)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Electrons</label>
                        <input type="range" id="electrons-n" min="0" max="6" value="2">
                        <span class="value-display" id="electrons-n-val">2</span>
                    </div>
                </div>
                <canvas id="microstate-canvas" width="600" height="180"></canvas>
                <div class="info-display">
                    <div id="microstate-formula">Microstates = C(6, 2)</div>
                    <div class="result" id="microstate-result">= 15</div>
                </div>
            </div>

            <p>For p² (2 electrons in p subshell): C(6, 2) = <strong>15 microstates</strong></p>
            <p>These 15 microstates span three term symbols: ³P (9), ¹D (5), ¹S (1).</p>

            <h3>Protein Sequences</h3>
            <p>How many possible sequences for a 100-residue protein?</p>
            <p>20 amino acid choices at each of 100 positions:</p>
            <p style="text-align: center; font-size: 1.2rem;">$20^{100} = 10^{130}$</p>

            <p>For comparison:</p>
            <ul>
                <li>Atoms in observable universe: ~10<sup>80</sup></li>
                <li>Seconds since Big Bang: ~10<sup>17</sup></li>
            </ul>

            <p><strong>The sequence space of even modest proteins is astronomically vast.</strong> This is why evolution explores only a tiny fraction of possible sequences.</p>

            <h3>Statistical Mechanics: Microstates</h3>
            <p><strong>The Boltzmann entropy:</strong></p>
            <p style="text-align: center; font-size: 1.2rem;">$$S = k_B \ln W$$</p>
            <p>where W is the number of microstates.</p>

            <p>If n₁ particles have energy E₁, n₂ have E₂, etc., the number of arrangements is:</p>
            <p style="text-align: center;">$$W = \frac{N!}{n_1! n_2! n_3! \cdots}$$</p>
            <p>This multinomial coefficient counts how many ways to partition N distinguishable particles into groups.</p>
        </section>

        <!-- Exercises -->
        <section id="exercises">
            <h2>Exercises</h2>

            <div class="exercise-box">
                <h4>Exercise 1: Basic Counting</h4>
                <p>(a) How many 5-letter "words" can be formed from the 26-letter alphabet (letters can repeat)?</p>
                <p>(b) How many if no letter can repeat?</p>
                <p>(c) How many 5-letter words have exactly one vowel (A, E, I, O, U)?</p>
            </div>

            <div class="exercise-box">
                <h4>Exercise 2: Factorials</h4>
                <p>(a) Compute 8!/5! without computing each factorial separately.</p>
                <p>(b) Simplify: n!/(n−2)!</p>
                <p>(c) Use Stirling's approximation to estimate ln(50!).</p>
            </div>

            <div class="exercise-box">
                <h4>Exercise 3: Permutations</h4>
                <p>(a) How many ways can 8 people stand in a line?</p>
                <p>(b) How many ways can 8 people sit at a round table? (Rotations are considered the same.)</p>
                <p>(c) How many distinct arrangements of the letters in CHEMISTRY?</p>
            </div>

            <div class="exercise-box">
                <h4>Exercise 4: Combinations</h4>
                <p>(a) From a standard 52-card deck, how many 5-card hands are possible?</p>
                <p>(b) How many of these hands contain exactly 2 aces?</p>
                <p>(c) How many contain at least one ace?</p>
            </div>

            <div class="exercise-box">
                <h4>Exercise 5: Chemistry Applications</h4>
                <p>(a) How many tripeptides can be formed from the 20 standard amino acids?</p>
                <p>(b) Methane (CH₄) has 4 equivalent H atoms. How many distinct mono-chlorinated products exist when one H is replaced by Cl?</p>
                <p>(c) For the complex [Co(NH₃)₄Cl₂]⁺, how many geometric isomers exist? (Hint: octahedral geometry)</p>
            </div>
        </section>

        <!-- Navigation -->
        <nav class="nav-links">
            <a href="../02-existence/">← Lecture 2: Existence</a>
            <a href="../04-direction/">Lecture 4: Bonds Point →</a>
        </nav>
    </div>

    <script>
        // Initialize KaTeX
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        });

        // Factorial function with BigInt for large values
        function factorial(n) {
            if (n <= 1) return 1n;
            let result = 1n;
            for (let i = 2n; i <= BigInt(n); i++) {
                result *= i;
            }
            return result;
        }

        function binomial(n, k) {
            if (k < 0 || k > n) return 0n;
            if (k === 0 || k === n) return 1n;
            return factorial(n) / (factorial(k) * factorial(n - k));
        }

        function formatBigInt(n) {
            const str = n.toString();
            if (str.length <= 15) return str.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return str.slice(0, 3) + "..." + str.slice(-3) + " (" + str.length + " digits)";
        }

        // ===== MULTIPLICATION PRINCIPLE TREE =====
        const treeCanvas = document.getElementById('tree-canvas');
        const treeCtx = treeCanvas.getContext('2d');
        const treeChoices = document.getElementById('tree-choices');
        const treeSteps = document.getElementById('tree-steps');
        const treeChoicesVal = document.getElementById('tree-choices-val');
        const treeStepsVal = document.getElementById('tree-steps-val');
        const treeFormula = document.getElementById('tree-formula');
        const treeResult = document.getElementById('tree-result');

        function drawTree() {
            const choices = parseInt(treeChoices.value);
            const steps = parseInt(treeSteps.value);
            const width = treeCanvas.width;
            const height = treeCanvas.height;

            treeCtx.fillStyle = '#12121a';
            treeCtx.fillRect(0, 0, width, height);

            // Calculate total outcomes
            let total = 1;
            let formula = '';
            for (let i = 0; i < steps; i++) {
                total *= choices;
                formula += (i > 0 ? ' × ' : '') + choices;
            }
            formula += ' = ';

            treeFormula.textContent = formula;
            treeResult.textContent = total + ' outcomes';
            treeChoicesVal.textContent = choices;
            treeStepsVal.textContent = steps;

            // Draw tree
            const startX = 60;
            const endX = width - 40;
            const stepWidth = (endX - startX) / steps;

            // Colors for branches
            const colors = ['#9d8cd9', '#7db3dc', '#8bc49d', '#d4a574'];

            // Draw connections first (behind nodes)
            function drawConnections(level, parentY, startY, rangeY) {
                if (level >= steps) return;

                const parentX = startX + level * stepWidth;
                const childX = startX + (level + 1) * stepWidth;
                const parentCount = Math.pow(choices, level);
                const parentSpacing = rangeY / parentCount;

                for (let p = 0; p < parentCount; p++) {
                    const py = startY + parentSpacing * (p + 0.5);
                    const childSpacing = parentSpacing / choices;

                    for (let c = 0; c < choices; c++) {
                        const cy = startY + parentSpacing * p + childSpacing * (c + 0.5);

                        treeCtx.beginPath();
                        treeCtx.moveTo(parentX, py);
                        treeCtx.lineTo(childX, cy);
                        treeCtx.strokeStyle = colors[c % colors.length];
                        treeCtx.lineWidth = Math.max(1, 3 - level * 0.5);
                        treeCtx.globalAlpha = 0.6;
                        treeCtx.stroke();
                        treeCtx.globalAlpha = 1;
                    }
                }

                drawConnections(level + 1, 0, startY, rangeY);
            }

            drawConnections(0, 0, 30, height - 60);

            // Draw nodes
            function drawNodes(level, startY, rangeY) {
                if (level > steps) return;

                const x = startX + level * stepWidth;
                const nodeCount = Math.pow(choices, level);
                const spacing = rangeY / nodeCount;

                for (let i = 0; i < nodeCount; i++) {
                    const y = startY + spacing * (i + 0.5);
                    const radius = level === 0 ? 10 : (level === steps ? 5 : 7);

                    treeCtx.beginPath();
                    treeCtx.arc(x, y, radius, 0, Math.PI * 2);
                    treeCtx.fillStyle = level === 0 ? '#d4a574' : (level === steps ? '#8bc49d' : '#9d8cd9');
                    treeCtx.fill();
                }

                drawNodes(level + 1, startY, rangeY);
            }

            drawNodes(0, 30, height - 60);

            // Labels
            treeCtx.fillStyle = '#a8a5a0';
            treeCtx.font = '12px "JetBrains Mono"';
            treeCtx.textAlign = 'center';

            for (let i = 0; i <= steps; i++) {
                const x = startX + i * stepWidth;
                if (i === 0) {
                    treeCtx.fillText('Start', x, height - 8);
                } else {
                    treeCtx.fillText('Step ' + i, x, height - 8);
                }
            }
        }

        treeChoices.addEventListener('input', drawTree);
        treeSteps.addEventListener('input', drawTree);
        drawTree();

        // ===== FACTORIAL CALCULATOR =====
        const factN = document.getElementById('fact-n');
        const factNVal = document.getElementById('fact-n-val');
        const factExpansion = document.getElementById('fact-expansion');
        const factResult = document.getElementById('fact-result');

        function updateFactorial() {
            const n = parseInt(factN.value);
            factNVal.textContent = n;

            if (n === 0) {
                factExpansion.textContent = '0! = 1 (by convention)';
                factResult.textContent = '= 1';
            } else {
                let expansion = n + '! = ';
                let terms = [];
                for (let i = n; i >= 1; i--) {
                    terms.push(i);
                }
                expansion += terms.join(' × ');
                factExpansion.textContent = expansion;
                factResult.textContent = '= ' + formatBigInt(factorial(n));
            }
        }

        factN.addEventListener('input', updateFactorial);
        updateFactorial();

        // ===== FACTORIAL GROWTH CHART =====
        const factCanvas = document.getElementById('factorial-canvas');
        const factCtx = factCanvas.getContext('2d');
        const factMax = document.getElementById('fact-max');
        const factMaxVal = document.getElementById('fact-max-val');

        function drawFactorialGrowth() {
            const maxN = parseInt(factMax.value);
            const width = factCanvas.width;
            const height = factCanvas.height;
            const padding = { left: 60, right: 30, top: 30, bottom: 40 };

            factCtx.fillStyle = '#12121a';
            factCtx.fillRect(0, 0, width, height);
            factMaxVal.textContent = maxN;

            // Calculate data
            const factData = [];
            const exp2Data = [];
            const exp10Data = [];

            for (let n = 1; n <= maxN; n++) {
                factData.push(Math.log10(Number(factorial(n))));
                exp2Data.push(n * Math.log10(2));
                exp10Data.push(n);
            }

            const maxY = Math.max(...factData);
            const scaleX = (width - padding.left - padding.right) / (maxN - 1);
            const scaleY = (height - padding.top - padding.bottom) / maxY;

            // Draw grid
            factCtx.strokeStyle = '#2a2a35';
            factCtx.lineWidth = 1;
            for (let y = 0; y <= maxY; y += Math.ceil(maxY / 5)) {
                const yPos = height - padding.bottom - y * scaleY;
                factCtx.beginPath();
                factCtx.moveTo(padding.left, yPos);
                factCtx.lineTo(width - padding.right, yPos);
                factCtx.stroke();
            }

            // Draw axes
            factCtx.strokeStyle = '#6b6966';
            factCtx.lineWidth = 2;
            factCtx.beginPath();
            factCtx.moveTo(padding.left, padding.top);
            factCtx.lineTo(padding.left, height - padding.bottom);
            factCtx.lineTo(width - padding.right, height - padding.bottom);
            factCtx.stroke();

            // Axis labels
            factCtx.fillStyle = '#a8a5a0';
            factCtx.font = '11px "JetBrains Mono"';
            factCtx.textAlign = 'center';

            for (let n = 1; n <= maxN; n++) {
                const x = padding.left + (n - 1) * scaleX;
                if (n % 2 === 0 || maxN <= 8) {
                    factCtx.fillText(n.toString(), x, height - padding.bottom + 18);
                }
            }

            factCtx.textAlign = 'right';
            for (let y = 0; y <= maxY; y += Math.ceil(maxY / 5)) {
                const yPos = height - padding.bottom - y * scaleY;
                factCtx.fillText('10^' + Math.round(y), padding.left - 5, yPos + 4);
            }

            // Y-axis label
            factCtx.save();
            factCtx.translate(15, height / 2);
            factCtx.rotate(-Math.PI / 2);
            factCtx.textAlign = 'center';
            factCtx.fillText('log₁₀(value)', 0, 0);
            factCtx.restore();

            // X-axis label
            factCtx.textAlign = 'center';
            factCtx.fillText('n', width / 2, height - 5);

            // Draw lines
            function drawLine(data, color, lineWidth) {
                factCtx.beginPath();
                for (let i = 0; i < data.length; i++) {
                    const x = padding.left + i * scaleX;
                    const y = height - padding.bottom - data[i] * scaleY;
                    if (i === 0) factCtx.moveTo(x, y);
                    else factCtx.lineTo(x, y);
                }
                factCtx.strokeStyle = color;
                factCtx.lineWidth = lineWidth;
                factCtx.stroke();

                // Draw points
                for (let i = 0; i < data.length; i++) {
                    const x = padding.left + i * scaleX;
                    const y = height - padding.bottom - data[i] * scaleY;
                    factCtx.beginPath();
                    factCtx.arc(x, y, 3, 0, Math.PI * 2);
                    factCtx.fillStyle = color;
                    factCtx.fill();
                }
            }

            drawLine(exp10Data, '#8bc49d', 2);  // 10^n (green)
            drawLine(exp2Data, '#dc8b8b', 2);   // 2^n (red)
            drawLine(factData, '#7db3dc', 3);   // n! (blue)
        }

        factMax.addEventListener('input', drawFactorialGrowth);
        drawFactorialGrowth();

        // ===== PERMUTATION CALCULATOR =====
        const permN = document.getElementById('perm-n');
        const permK = document.getElementById('perm-k');
        const permNVal = document.getElementById('perm-n-val');
        const permKVal = document.getElementById('perm-k-val');
        const permFormula = document.getElementById('perm-formula');
        const permResult = document.getElementById('perm-result');

        function updatePermutation() {
            const n = parseInt(permN.value);
            let k = parseInt(permK.value);

            if (k > n) {
                k = n;
                permK.value = n;
            }
            permK.max = n;

            permNVal.textContent = n;
            permKVal.textContent = k;

            let terms = [];
            for (let i = n; i > n - k; i--) {
                terms.push(i);
            }

            permFormula.textContent = `P(${n}, ${k}) = ${terms.join(' × ')}`;

            const result = factorial(n) / factorial(n - k);
            permResult.textContent = '= ' + formatBigInt(result);
        }

        permN.addEventListener('input', updatePermutation);
        permK.addEventListener('input', updatePermutation);
        updatePermutation();

        // ===== COMBINATION CALCULATOR =====
        const combN = document.getElementById('comb-n');
        const combK = document.getElementById('comb-k');
        const combNVal = document.getElementById('comb-n-val');
        const combKVal = document.getElementById('comb-k-val');
        const combFormula = document.getElementById('comb-formula');
        const combResult = document.getElementById('comb-result');
        const combSymmetry = document.getElementById('comb-symmetry');

        function updateCombination() {
            const n = parseInt(combN.value);
            let k = parseInt(combK.value);

            if (k > n) {
                k = n;
                combK.value = n;
            }
            combK.max = n;

            combNVal.textContent = n;
            combKVal.textContent = k;

            combFormula.textContent = `C(${n}, ${k}) = ${n}! / (${k}! × ${n-k}!)`;

            const result = binomial(n, k);
            combResult.textContent = '= ' + formatBigInt(result);
            combSymmetry.textContent = `Symmetry: C(${n}, ${k}) = C(${n}, ${n-k}) = ${formatBigInt(result)}`;
        }

        combN.addEventListener('input', updateCombination);
        combK.addEventListener('input', updateCombination);
        updateCombination();

        // ===== PASCAL'S TRIANGLE =====
        const pascalRows = document.getElementById('pascal-rows');
        const pascalRowsVal = document.getElementById('pascal-rows-val');
        const pascalDisplay = document.getElementById('pascal-display');
        const pascalInfo = document.getElementById('pascal-info');

        function drawPascal() {
            const rows = parseInt(pascalRows.value);
            pascalRowsVal.textContent = rows;
            pascalDisplay.innerHTML = '';

            for (let n = 0; n < rows; n++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'pascal-row';

                for (let k = 0; k <= n; k++) {
                    const entry = document.createElement('span');
                    entry.className = 'pascal-entry';
                    entry.textContent = binomial(n, k).toString();
                    entry.dataset.n = n;
                    entry.dataset.k = k;

                    entry.addEventListener('click', function() {
                        // Remove previous highlights
                        document.querySelectorAll('.pascal-entry.highlighted').forEach(el => {
                            el.classList.remove('highlighted');
                        });

                        this.classList.add('highlighted');

                        const clickN = parseInt(this.dataset.n);
                        const clickK = parseInt(this.dataset.k);
                        const val = binomial(clickN, clickK);

                        if (clickN > 0 && clickK > 0 && clickK < clickN) {
                            const left = binomial(clickN - 1, clickK - 1);
                            const right = binomial(clickN - 1, clickK);
                            pascalInfo.innerHTML = `C(${clickN}, ${clickK}) = ${val}<br>` +
                                `= C(${clickN-1}, ${clickK-1}) + C(${clickN-1}, ${clickK})<br>` +
                                `= ${left} + ${right}`;
                        } else {
                            pascalInfo.innerHTML = `C(${clickN}, ${clickK}) = ${val}`;
                        }
                    });

                    rowDiv.appendChild(entry);
                }

                pascalDisplay.appendChild(rowDiv);
            }

            // Row sum
            const lastRow = rows - 1;
            let sum = 0n;
            for (let k = 0; k <= lastRow; k++) {
                sum += binomial(lastRow, k);
            }
            pascalInfo.innerHTML = `Row ${lastRow} sum = ${sum} = 2<sup>${lastRow}</sup><br>Click any entry to see Pascal's identity`;
        }

        pascalRows.addEventListener('input', drawPascal);
        drawPascal();

        // ===== BENZENE SUBSTITUTION =====
        const benzeneCanvas = document.getElementById('benzene-canvas');
        const benzeneCtx = benzeneCanvas.getContext('2d');
        const benzeneNcl = document.getElementById('benzene-ncl');
        const benzeneNclVal = document.getElementById('benzene-ncl-val');
        const benzeneK = document.getElementById('benzene-k');
        const benzeneNaive = document.getElementById('benzene-naive');
        const benzeneActual = document.getElementById('benzene-actual');
        const isomerCards = document.getElementById('isomer-cards');

        // Isomer data
        const isomerData = {
            0: { count: 1, isomers: [{name: 'Benzene', positions: []}] },
            1: { count: 1, isomers: [{name: 'Chlorobenzene', positions: [1]}] },
            2: { count: 3, isomers: [
                {name: 'ortho (1,2)', positions: [1, 2]},
                {name: 'meta (1,3)', positions: [1, 3]},
                {name: 'para (1,4)', positions: [1, 4]}
            ]},
            3: { count: 3, isomers: [
                {name: '1,2,3-', positions: [1, 2, 3]},
                {name: '1,2,4-', positions: [1, 2, 4]},
                {name: '1,3,5-', positions: [1, 3, 5]}
            ]},
            4: { count: 3, isomers: [
                {name: '1,2,3,4-', positions: [1, 2, 3, 4]},
                {name: '1,2,3,5-', positions: [1, 2, 3, 5]},
                {name: '1,2,4,5-', positions: [1, 2, 4, 5]}
            ]},
            5: { count: 1, isomers: [{name: 'Pentachloro', positions: [1, 2, 3, 4, 5]}] },
            6: { count: 1, isomers: [{name: 'Hexachloro', positions: [1, 2, 3, 4, 5, 6]}] }
        };

        let selectedIsomerIndex = 0;

        function drawBenzene() {
            const ncl = parseInt(benzeneNcl.value);
            const width = benzeneCanvas.width;
            const height = benzeneCanvas.height;

            benzeneCtx.fillStyle = '#12121a';
            benzeneCtx.fillRect(0, 0, width, height);

            benzeneNclVal.textContent = ncl;
            benzeneK.textContent = ncl;
            benzeneNaive.textContent = Number(binomial(6, ncl));
            benzeneActual.textContent = isomerData[ncl].count;

            const centerX = width / 2;
            const centerY = height / 2 - 20;
            const radius = 90;

            // Draw ring
            benzeneCtx.beginPath();
            for (let i = 0; i <= 6; i++) {
                const angle = -Math.PI / 2 + (i * Math.PI * 2 / 6);
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                if (i === 0) benzeneCtx.moveTo(x, y);
                else benzeneCtx.lineTo(x, y);
            }
            benzeneCtx.strokeStyle = '#6b6966';
            benzeneCtx.lineWidth = 2;
            benzeneCtx.stroke();

            // Inner circle for aromaticity
            benzeneCtx.beginPath();
            benzeneCtx.arc(centerX, centerY, radius * 0.5, 0, Math.PI * 2);
            benzeneCtx.strokeStyle = 'rgba(107, 105, 102, 0.5)';
            benzeneCtx.stroke();

            // Draw positions
            const currentIsomer = isomerData[ncl].isomers[selectedIsomerIndex];
            const clPositions = currentIsomer ? currentIsomer.positions : [];

            for (let i = 1; i <= 6; i++) {
                const angle = -Math.PI / 2 + ((i - 1) * Math.PI * 2 / 6);
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const isCl = clPositions.includes(i);

                // Draw atom
                benzeneCtx.beginPath();
                benzeneCtx.arc(x, y, 20, 0, Math.PI * 2);
                benzeneCtx.fillStyle = isCl ? '#8bc49d' : '#2a2a35';
                benzeneCtx.fill();
                benzeneCtx.strokeStyle = isCl ? '#8bc49d' : '#6b6966';
                benzeneCtx.lineWidth = 2;
                benzeneCtx.stroke();

                // Label
                benzeneCtx.fillStyle = isCl ? '#0a0a0f' : '#a8a5a0';
                benzeneCtx.font = 'bold 13px "JetBrains Mono"';
                benzeneCtx.textAlign = 'center';
                benzeneCtx.textBaseline = 'middle';
                benzeneCtx.fillText(isCl ? 'Cl' : i.toString(), x, y);
            }

            // Update isomer cards
            isomerCards.innerHTML = '';
            isomerData[ncl].isomers.forEach((isomer, idx) => {
                const card = document.createElement('div');
                card.className = 'isomer-card' + (idx === selectedIsomerIndex ? ' active' : '');
                card.innerHTML = `
                    <div class="isomer-name">${isomer.name}</div>
                    <div class="isomer-positions">${isomer.positions.length > 0 ? 'Positions: ' + isomer.positions.join(', ') : '—'}</div>
                `;
                card.addEventListener('click', () => {
                    selectedIsomerIndex = idx;
                    drawBenzene();
                });
                isomerCards.appendChild(card);
            });
        }

        benzeneNcl.addEventListener('input', () => {
            selectedIsomerIndex = 0;
            drawBenzene();
        });
        drawBenzene();

        // ===== ELECTRON MICROSTATES =====
        const microstateCanvas = document.getElementById('microstate-canvas');
        const microstateCtx = microstateCanvas.getContext('2d');
        const subshellSelect = document.getElementById('subshell-select');
        const electronsN = document.getElementById('electrons-n');
        const electronsNVal = document.getElementById('electrons-n-val');
        const microstateFormula = document.getElementById('microstate-formula');
        const microstateResult = document.getElementById('microstate-result');

        const subshellData = {
            's': { orbitals: 1, spinOrbitals: 2, maxElectrons: 2 },
            'p': { orbitals: 3, spinOrbitals: 6, maxElectrons: 6 },
            'd': { orbitals: 5, spinOrbitals: 10, maxElectrons: 10 },
            'f': { orbitals: 7, spinOrbitals: 14, maxElectrons: 14 }
        };

        function drawMicrostates() {
            const subshell = subshellSelect.value;
            const data = subshellData[subshell];
            let n = parseInt(electronsN.value);

            // Clamp electrons to max
            if (n > data.maxElectrons) {
                n = data.maxElectrons;
                electronsN.value = n;
            }
            electronsN.max = data.maxElectrons;
            electronsNVal.textContent = n;

            const spinOrbs = data.spinOrbitals;
            const microstates = binomial(spinOrbs, n);

            microstateFormula.textContent = `Microstates = C(${spinOrbs}, ${n})`;
            microstateResult.textContent = '= ' + formatBigInt(microstates);

            // Draw orbital diagram
            const width = microstateCanvas.width;
            const height = microstateCanvas.height;
            microstateCtx.fillStyle = '#12121a';
            microstateCtx.fillRect(0, 0, width, height);

            const orbitals = data.orbitals;
            const boxWidth = 45;
            const boxHeight = 55;
            const spacing = 12;
            const totalWidth = orbitals * boxWidth + (orbitals - 1) * spacing;
            const startX = (width - totalWidth) / 2;
            const startY = (height - boxHeight) / 2 - 10;

            // Calculate a sample ground-state-like distribution (Hund's rule)
            let remaining = n;
            const orbitalElectrons = [];

            // First pass: one electron per orbital (Hund's rule)
            for (let i = 0; i < orbitals && remaining > 0; i++) {
                orbitalElectrons[i] = 1;
                remaining--;
            }
            // Second pass: pair up
            for (let i = 0; i < orbitals && remaining > 0; i++) {
                if (orbitalElectrons[i] < 2) {
                    orbitalElectrons[i]++;
                    remaining--;
                }
            }
            // Fill remaining if needed
            for (let i = 0; i < orbitals; i++) {
                if (orbitalElectrons[i] === undefined) orbitalElectrons[i] = 0;
            }

            // Draw orbitals
            for (let i = 0; i < orbitals; i++) {
                const x = startX + i * (boxWidth + spacing);

                // Box
                microstateCtx.strokeStyle = '#6b6966';
                microstateCtx.lineWidth = 2;
                microstateCtx.strokeRect(x, startY, boxWidth, boxHeight);

                // Electrons (arrows)
                const numE = orbitalElectrons[i];
                const arrowY = startY + boxHeight / 2;

                if (numE >= 1) {
                    // Up arrow
                    const ax = x + boxWidth / 3;
                    microstateCtx.beginPath();
                    microstateCtx.moveTo(ax, arrowY + 15);
                    microstateCtx.lineTo(ax, arrowY - 15);
                    microstateCtx.strokeStyle = '#7db3dc';
                    microstateCtx.lineWidth = 2.5;
                    microstateCtx.stroke();
                    // Arrowhead
                    microstateCtx.beginPath();
                    microstateCtx.moveTo(ax - 5, arrowY - 10);
                    microstateCtx.lineTo(ax, arrowY - 18);
                    microstateCtx.lineTo(ax + 5, arrowY - 10);
                    microstateCtx.stroke();
                }

                if (numE >= 2) {
                    // Down arrow
                    const ax = x + 2 * boxWidth / 3;
                    microstateCtx.beginPath();
                    microstateCtx.moveTo(ax, arrowY - 15);
                    microstateCtx.lineTo(ax, arrowY + 15);
                    microstateCtx.strokeStyle = '#dc8b8b';
                    microstateCtx.lineWidth = 2.5;
                    microstateCtx.stroke();
                    // Arrowhead
                    microstateCtx.beginPath();
                    microstateCtx.moveTo(ax - 5, arrowY + 10);
                    microstateCtx.lineTo(ax, arrowY + 18);
                    microstateCtx.lineTo(ax + 5, arrowY + 10);
                    microstateCtx.stroke();
                }

                // Label
                microstateCtx.fillStyle = '#6b6966';
                microstateCtx.font = '10px "JetBrains Mono"';
                microstateCtx.textAlign = 'center';
                const ml = subshell === 's' ? 0 :
                           subshell === 'p' ? i - 1 :
                           subshell === 'd' ? i - 2 :
                           i - 3;
                microstateCtx.fillText('mₗ=' + ml, x + boxWidth/2, startY + boxHeight + 15);
            }

            // Caption
            microstateCtx.fillStyle = '#a8a5a0';
            microstateCtx.font = '11px "JetBrains Mono"';
            microstateCtx.textAlign = 'center';
            microstateCtx.fillText(`${subshell}${n} configuration — one of ${formatBigInt(microstates)} microstates (ground state shown)`, width/2, height - 8);
        }

        subshellSelect.addEventListener('change', drawMicrostates);
        electronsN.addEventListener('input', drawMicrostates);
        drawMicrostates();
    </script>
</body>
</html>
